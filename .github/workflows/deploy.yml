name: Deploy Application

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

env:
  NODE_VERSION: '20'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            infra/package-lock.json
            ui/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Setup uv
        uses: astral-sh/setup-uv@v3
        with:
          version: 'latest'

      - name: Lint API
        working-directory: api
        run: uv run --extra dev ruff check

      - name: Test API
        working-directory: api
        run: uv run --extra dev pytest

      - name: Install infra dependencies
        working-directory: infra
        run: npm ci

      - name: Build infra TypeScript
        working-directory: infra
        run: npm run build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Deploy CDK stacks
        working-directory: infra
        run: |
          set -euxo pipefail
          npx cdk deploy InfraStack UiStack --require-approval never
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name InfraStack \
            --query "Stacks[0].Outputs[?OutputKey=='ApiBaseUrl'].OutputValue" \
            --output text)
          UI_BUCKET=$(aws cloudformation describe-stacks \
            --stack-name UiStack \
            --query "Stacks[0].Outputs[?OutputKey=='UiBucketName'].OutputValue" \
            --output text)
          UI_DIST_ID=$(aws cloudformation describe-stacks \
            --stack-name UiStack \
            --query "Stacks[0].Outputs[?OutputKey=='UiDistributionId'].OutputValue" \
            --output text)
          UI_DOMAIN=$(aws cloudformation describe-stacks \
            --stack-name UiStack \
            --query "Stacks[0].Outputs[?OutputKey=='UiDistributionDomainName'].OutputValue" \
            --output text)
          test -n "$API_URL" && echo "API_URL=$API_URL" >> "$GITHUB_ENV"
          test -n "$UI_BUCKET" && echo "UI_BUCKET=$UI_BUCKET" >> "$GITHUB_ENV"
          test -n "$UI_DIST_ID" && echo "UI_DIST_ID=$UI_DIST_ID" >> "$GITHUB_ENV"
          test -n "$UI_DOMAIN" && echo "UI_DOMAIN=$UI_DOMAIN" >> "$GITHUB_ENV"

      - name: Install UI dependencies
        working-directory: ui
        run: npm ci

      - name: Build UI
        working-directory: ui
        env:
          NEXT_PUBLIC_FARMPL_API_BASE: ${{ env.API_URL }}
          NEXT_PUBLIC_DOCS_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
        run: |
          set -euxo pipefail
          npm run build

      - name: Upload static assets
        working-directory: ui
        env:
          UI_BUCKET: ${{ env.UI_BUCKET }}
        run: |
          set -euxo pipefail
          test -n "$UI_BUCKET" || { echo 'UI_BUCKET is empty. Check CloudFormation outputs.'; exit 1; }
          aws s3 sync out/ "s3://$UI_BUCKET" --delete

      - name: Invalidate CloudFront cache
        env:
          UI_DIST_ID: ${{ env.UI_DIST_ID }}
          UI_DOMAIN: ${{ env.UI_DOMAIN }}
        run: |
          set -euxo pipefail
          aws cloudfront create-invalidation --distribution-id "$UI_DIST_ID" --paths '/*'
          printf 'Deployed UI: https://%s\n' "$UI_DOMAIN"
