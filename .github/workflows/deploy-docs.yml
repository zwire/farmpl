name: Deploy MkDocs to GitHub Pages

on:
  push:
    branches: [ "main" ]
  workflow_run:
    workflows: ["Deploy Application"]
    types: ["completed"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
      - name: Configure AWS credentials (to fetch APP_URL)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ vars.AWS_REGION }}
      - name: Discover App URL (CloudFront)
        id: discover
        shell: bash
        run: |
          set -euo pipefail
          for i in $(seq 1 10); do
            DOMAIN=$(aws cloudformation describe-stacks \
              --stack-name UiStack \
              --query "Stacks[0].Outputs[?OutputKey=='UiDistributionDomainName'].OutputValue" \
              --output text || true)
            if [ -n "$DOMAIN" ] && [ "$DOMAIN" != "None" ]; then
              break
            fi
            echo "UiStack output not ready (attempt $i/10). Sleeping 30s..."
            sleep 30
          done
          if [ -z "$DOMAIN" ] || [ "$DOMAIN" = "None" ]; then
            if [ -n "${{ vars.DOCS_APP_URL }}" ]; then
              echo "Using fallback DOCS_APP_URL"
              FALLBACK_URL="${{ vars.DOCS_APP_URL }}"
              echo "app_url=$FALLBACK_URL" >> $GITHUB_OUTPUT
              echo "APP_URL=$FALLBACK_URL" >> $GITHUB_ENV
              exit 0
            fi
            echo "Failed to resolve UiDistributionDomainName and no fallback provided" >&2
            exit 1
          fi
          echo "app_url=https://$DOMAIN" >> $GITHUB_OUTPUT
          echo "APP_URL=https://$DOMAIN" >> $GITHUB_ENV
      - name: Install MkDocs
        run: |
          pip install -r docs/requirements.txt
      - name: Build
        run: |
          # Use APP_URL from environment (set in previous step)
          APP_URL_VALUE="${APP_URL:-http://localhost:3000}"
          if [ "$APP_URL_VALUE" = "None" ]; then
            APP_URL_VALUE="http://localhost:3000"
          fi
          echo "Using APP_URL=$APP_URL_VALUE"
          # Replace extra.app_url in mkdocs.yml
          sed -i "s|app_url:.*|app_url: $APP_URL_VALUE|" mkdocs.yml
          echo "Updated mkdocs.yml with app_url=$APP_URL_VALUE"
          mkdocs build --strict
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - id: deployment
        uses: actions/deploy-pages@v4
