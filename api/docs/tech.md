# 技術スタック

## プログラミング言語 / ライブラリ

- Python 3.13
- uv (パッケージ管理)
- ruff (フォーマット)
- Pydantic (スキーマ記述&型バリデーション)
- OR-Tools + CP-SAT (最適化)

## 技術的アプローチ

- 段階的（レキシコ）最適化アプローチを採用
  - 複数の目的の優先順位を明示し、各段で単一目的を最適化して水準をロックする
  - 以下 3 つの観点を順に評価することで解が導かれるイメージ
    - 作れるか？(実現可能性)
    - 効率的か？(コスト最適性)
    - リスクは？(品質/安定性)
- 期間は日単位の離散時間で表現（将来、時間窓(h)に細分化可能）
- 各制約は簡単に ON/OFF でき、単体テストが容易にできるような、疎結合な共通インターフェース設計
  - 各制約は独立して記述することができ、互いに実装が干渉することはない
- 解釈性も必要 (実現可能性を満たさない場合に何がネックになっているか)

## 変数設計メモ（現状）

- 決定変数は `x[l,c,t]`（日別面積）・`z[l,c]`（採用二値）・`r[e,t]`（イベント実施）・`h[w,e,t]`（労働）ほか。
- スケール: 面積は `AREA_SCALE_UNITS_PER_A=10`（1 unit=0.1a）。
- 実装戦略:
  - 各制約は `BuildContext` からスケールと変数を取得（時間軸あり前提）。
  - 土地容量は日別（Σ_c x[l,c,t] ≤ area_l）。
  - FixedArea は合計（Σ_t x[l,c,t] ≥ fixed）。
  - 作物面積の上下限は日別合計（∀t: lo ≤ Σ_l x[l,c,t] ≤ hi）。

## 将来計画: 時間窓 (h) の導入

現状は日単位の離散時間 `t=1..H` でモデル化しているが、日内の時間窓（hour slots, `h=1..K`）を導入してピーク負荷や同時並行の混雑をより高精度に扱う計画。

- 追加変数（案）
  - `h_time[w,e,t,h]`（h単位の作業時間）
  - `u_time[r,e,t,h]`（h単位のリソース使用）
  - `assign[w,e,t,h]`（h単位のアサイン）

- 基本制約（案）
  - 作業者日内容量: `Σ_{e,h} h_time[w,e,t,h] ≤ capacity_per_day_w`
  - リソース日内容量: `Σ_{e,h} u_time[r,e,t,h] ≤ capacity_per_day_r`
  - イベント日内上限: `Σ_{w,h} h_time[w,e,t,h] ≤ labor_daily_cap_e · r[e,t]`
  - 役割充足・排他などの論理は h に拡張

- 目的関数（案）
  - `peak`（日内ピーク）: `max_t Σ_{w,e,h} h_time[w,e,t,h]` を最小化（補助変数で線形化）
  - `smoothness`（平準化）: 近接 hslot 間の差分を最小化

- 実装方針
  - まずは `K=2..4` の粗い分割で導入し、性能と利得を評価
  - 既存の日次モデルと両立するよう、段階的に切替可能な形で実装
